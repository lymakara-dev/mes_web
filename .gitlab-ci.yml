image: node:20

stages:
  - install
  - build
  - deploy

variables:
  # Tell npm to use the global cache dir of gitlab-runner user
  NPM_CONFIG_CACHE: "/home/gitlab-runner/.npm"

install_dependencies:
  stage: install
  script:
    - echo "Installing dependencies..."
    - npm ci
  cache:
    key: ${CI_PROJECT_PATH}-${CI_COMMIT_REF_SLUG}
    paths:
      # Cache the global npm cache folder, NOT local node_modules
      - /home/gitlab-runner/.npm
      # Optionally cache node_modules if needed (but usually caching npm cache is enough)
      # - node_modules/
  # Since cache path is outside project dir, cache policy needs to be enabled accordingly

build_app:
  stage: build
  script:
    - echo "Building app..."
    - npm run build
  cache:
    key: ${CI_PROJECT_PATH}-${CI_COMMIT_REF_SLUG}
    paths:
      - /home/gitlab-runner/.npm

deploy:
  stage: deploy
  before_script:
    - echo "üîê Preparing SSH access..."
  script:
    - echo "üöÄ Deploying to $APP_DIR on 192.168.71.110.."
    - |
      cd /home/gic/mes-deployment/mes_web &&
      GIT_SSH_COMMAND='ssh -i ~/.ssh/gitlab' git pull origin &&
      docker build -t mes-web . && docker run -d -p 9004:3000 mes-web
      "
  only:
    - main
